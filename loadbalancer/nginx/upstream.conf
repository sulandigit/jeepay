# 上游服务器配置文件

# 支付网关服务集群
upstream payment_servers {
    # 加权轮询算法
    least_conn;
    
    # 服务器定义
    server payment-1:9216 weight=3 max_fails=3 fail_timeout=30s;
    server payment-2:9216 weight=3 max_fails=3 fail_timeout=30s;
    server payment-3:9216 weight=2 max_fails=3 fail_timeout=30s;
    
    # 备用服务器
    server payment-backup:9216 backup weight=1;
    
    # 长连接配置
    keepalive 16;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# 运营平台服务集群
upstream manager_servers {
    # 轮询算法
    
    # 服务器定义
    server manager-1:9217 weight=1 max_fails=2 fail_timeout=30s;
    server manager-2:9217 weight=1 max_fails=2 fail_timeout=30s;
    
    # 长连接配置
    keepalive 8;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# 商户平台服务集群
upstream merchant_servers {
    # IP哈希算法 - 实现会话保持
    ip_hash;
    
    # 服务器定义
    server merchant-1:9218 weight=1 max_fails=2 fail_timeout=30s;
    server merchant-2:9218 weight=1 max_fails=2 fail_timeout=30s;
    
    # 长连接配置
    keepalive 8;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# 健康检查配置
# 需要nginx-plus或者第三方模块支持主动健康检查
# 这里使用被动健康检查（max_fails, fail_timeout）

# 配置说明：
# weight: 权重，数值越大接收请求越多
# max_fails: 最大失败次数，超过后标记为不可用
# fail_timeout: 失败超时时间，在此时间内不会向失败服务器转发请求
# backup: 备用服务器，只有主服务器都不可用时才使用
# down: 标记服务器永久不可用
# keepalive: 与上游服务器保持的空闲长连接数
# keepalive_requests: 单个长连接可以处理的请求数
# keepalive_timeout: 长连接超时时间