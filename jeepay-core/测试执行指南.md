# å…¨å±€æ ¡éªŒå¼‚å¸¸å¤„ç† - æµ‹è¯•æ‰§è¡ŒæŒ‡å—

## ğŸ“‹ å®ç°æ¦‚è§ˆ

æœ¬æ¬¡å®ç°å·²å®Œæˆ Jeepay æ”¯ä»˜ç³»ç»Ÿçš„å…¨å±€æ ¡éªŒå¼‚å¸¸å¤„ç†åŠŸèƒ½ï¼Œç»Ÿä¸€å¤„ç† JSR-303/JSR-380 å‚æ•°æ ¡éªŒå¼‚å¸¸ã€‚

### âœ… å·²å®Œæˆçš„å·¥ä½œ

#### 1. æ ¸å¿ƒä»£ç ä¿®æ”¹

**ä¿®æ”¹æ–‡ä»¶**: `jeepay-core/src/main/java/com/jeequan/jeepay/core/exception/BizExceptionResolver.java`

**æ–°å¢åŠŸèƒ½**:
- âœ… å¤„ç† `MethodArgumentNotValidException` - è¯·æ±‚ä½“ JSON å‚æ•°æ ¡éªŒå¼‚å¸¸
- âœ… å¤„ç† `BindException` - è¡¨å•å‚æ•°æ ¡éªŒå¼‚å¸¸  
- âœ… å¤„ç† `ConstraintViolationException` - å•å‚æ•°æ ¡éªŒå¼‚å¸¸
- âœ… æ·»åŠ  WARN çº§åˆ«æ—¥å¿—è®°å½•ï¼ŒåŒ…å«è¯·æ±‚è·¯å¾„ã€é”™è¯¯å­—æ®µã€é”™è¯¯ä¿¡æ¯
- âœ… ä¿æŒç°æœ‰å¼‚å¸¸å¤„ç†é€»è¾‘ä¸å—å½±å“

**å¼‚å¸¸å¤„ç†ä¼˜å…ˆçº§é¡ºåº**:
1. MethodArgumentNotValidException (æ–°å¢)
2. BindException (æ–°å¢)
3. ConstraintViolationException (æ–°å¢)
4. BizException (å·²å­˜åœ¨)
5. DataAccessException (å·²å­˜åœ¨)
6. AccessDeniedException (å·²å­˜åœ¨)
7. Exception (å·²å­˜åœ¨)

#### 2. å•å…ƒæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**: `jeepay-core/src/test/java/com/jeequan/jeepay/core/exception/BizExceptionResolverTest.java`

**æµ‹è¯•ç”¨ä¾‹è¦†ç›–**:
- âœ… TC-001: æµ‹è¯• MethodArgumentNotValidException åŒ…å«å­—æ®µé”™è¯¯
- âœ… TC-002: æµ‹è¯• MethodArgumentNotValidException æ— å­—æ®µé”™è¯¯ï¼ˆè¾¹ç•Œæƒ…å†µï¼‰
- âœ… TC-003: æµ‹è¯• BindException åŒ…å«å­—æ®µé”™è¯¯
- âœ… TC-004: æµ‹è¯• ConstraintViolationException åŒ…å«è¿è§„ä¿¡æ¯
- âœ… TC-005: æµ‹è¯• ConstraintViolationException æ— è¿è§„ä¿¡æ¯ï¼ˆè¾¹ç•Œæƒ…å†µï¼‰
- âœ… TC-006: æµ‹è¯•å¤šå­—æ®µé”™è¯¯è¿”å›ç¬¬ä¸€ä¸ªé”™è¯¯
- âœ… å›å½’æµ‹è¯•: BizException å¤„ç†æœªå—å½±å“
- âœ… å›å½’æµ‹è¯•: DataAccessException å¤„ç†æœªå—å½±å“
- âœ… å›å½’æµ‹è¯•: Exception å¤„ç†æœªå—å½±å“
- âœ… éªŒè¯ ApiRes å“åº”æ ¼å¼è§„èŒƒ

---

## ğŸ§ª æµ‹è¯•æ‰§è¡Œæ­¥éª¤

### æ–¹å¼ä¸€ï¼šMaven å‘½ä»¤è¡Œæµ‹è¯•

#### 1. æ‰§è¡Œå•å…ƒæµ‹è¯•

```bash
# è¿›å…¥ jeepay-core æ¨¡å—ç›®å½•
cd /data/workspace/jeepay/jeepay-core

# æ‰§è¡Œæµ‹è¯•
mvn clean test -Dtest=BizExceptionResolverTest

# æŸ¥çœ‹æµ‹è¯•ç»“æœ
cat target/surefire-reports/com.jeequan.jeepay.core.exception.BizExceptionResolverTest.txt
```

#### 2. ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
# æ‰§è¡Œæµ‹è¯•å¹¶ç”Ÿæˆ JaCoCo è¦†ç›–ç‡æŠ¥å‘Š
mvn clean test

# æŸ¥çœ‹ HTML è¦†ç›–ç‡æŠ¥å‘Š
# æŠ¥å‘Šä½ç½®: target/site/jacoco/index.html
```

#### 3. éªŒè¯è¦†ç›–ç‡è¾¾æ ‡

**è¦†ç›–ç‡ç›®æ ‡**:
- BizExceptionResolver ç±»è¡Œè¦†ç›–ç‡: â‰¥ 80%
- åˆ†æ”¯è¦†ç›–ç‡: â‰¥ 75%
- æ–°å¢æ ¡éªŒå¼‚å¸¸å¤„ç†åˆ†æ”¯: 100%

**æŸ¥çœ‹æ–¹å¼**:
1. æ‰“å¼€ `target/site/jacoco/index.html`
2. å¯¼èˆªè‡³ `com.jeequan.jeepay.core.exception` åŒ…
3. ç‚¹å‡» `BizExceptionResolver` æŸ¥çœ‹è¯¦ç»†è¦†ç›–ç‡

---

### æ–¹å¼äºŒï¼šIDE ä¸­æ‰§è¡Œæµ‹è¯•

#### IntelliJ IDEA

1. æ‰“å¼€é¡¹ç›®å¯¼å…¥ Maven ä¾èµ–
2. å³é”®ç‚¹å‡» `BizExceptionResolverTest` ç±»
3. é€‰æ‹© "Run 'BizExceptionResolverTest' with Coverage"
4. æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Šçª—å£

#### Eclipse

1. å³é”®ç‚¹å‡» `BizExceptionResolverTest` ç±»
2. é€‰æ‹© "Coverage As" -> "JUnit Test"
3. æŸ¥çœ‹ Coverage è§†å›¾

---

## ğŸ” é›†æˆæµ‹è¯•éªŒè¯

### æµ‹è¯•ç›®æ ‡

åœ¨å®é™…è¿è¡Œç¯å¢ƒä¸­éªŒè¯ä¸‰ä¸ªæœåŠ¡æ¨¡å—çš„æ ¡éªŒå¼‚å¸¸å¤„ç†ã€‚

### æµ‹è¯•æœåŠ¡åˆ—è¡¨

| æœåŠ¡åç§° | ç«¯å£ | æµ‹è¯•æ¥å£ç¤ºä¾‹ |
|---------|-----|-------------|
| jeepay-payment | 9216 | POST /api/pay/unifiedOrder |
| jeepay-manager | 9217 | POST /api/sysUsers |
| jeepay-merchant | 9218 | POST /api/sysUsers |

### æµ‹è¯•æ­¥éª¤

#### 1. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ jeepay-payment
cd /data/workspace/jeepay/jeepay-payment
mvn spring-boot:run

# å¯åŠ¨ jeepay-manager
cd /data/workspace/jeepay/jeepay-manager
mvn spring-boot:run

# å¯åŠ¨ jeepay-merchant  
cd /data/workspace/jeepay/jeepay-merchant
mvn spring-boot:run
```

#### 2. ä½¿ç”¨ curl æµ‹è¯•æ ¡éªŒå¼‚å¸¸

**æµ‹è¯• MethodArgumentNotValidException (è¯·æ±‚ä½“æ ¡éªŒ)**:

```bash
# æµ‹è¯• jeepay-payment ç»Ÿä¸€ä¸‹å•æ¥å£ï¼ˆç¼ºå°‘å¿…å¡«å­—æ®µï¼‰
curl -X POST http://localhost:9216/api/pay/unifiedOrder \
  -H "Content-Type: application/json" \
  -d '{
    "mchNo": "M1621873433953",
    "appId": "60cc09bce4b0f1c0b83761c9"
  }'
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 11,
  "msg": "å‚æ•°æœ‰è¯¯[å•†æˆ·è®¢å•å·ä¸èƒ½ä¸ºç©º]",
  "data": null,
  "sign": null
}
```

**æµ‹è¯• ConstraintViolationException (å•å‚æ•°æ ¡éªŒ)**:

```bash
# æµ‹è¯•è·¯å¾„å‚æ•°æ ¡éªŒï¼ˆå‡è®¾æœ‰æ ¡éªŒæ³¨è§£ï¼‰
curl -X GET "http://localhost:9217/api/test?pageSize=-1"
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 11,
  "msg": "å‚æ•°æœ‰è¯¯[é¡µé¢å¤§å°å¿…é¡»å¤§äº0]",
  "data": null,
  "sign": null
}
```

#### 3. æ£€æŸ¥æ—¥å¿—è¾“å‡º

æŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼Œç¡®è®¤ WARN çº§åˆ«æ—¥å¿—è®°å½•ï¼š

```bash
# æŸ¥çœ‹ payment æœåŠ¡æ—¥å¿—
tail -f /data/workspace/jeepay/jeepay-payment/logs/jeepay-payment.log | grep "å‚æ•°æ ¡éªŒå¤±è´¥"
```

**é¢„æœŸæ—¥å¿—æ ¼å¼**:
```
WARN  [BizExceptionResolver] - å‚æ•°æ ¡éªŒå¤±è´¥ï¼šè¯·æ±‚è·¯å¾„=/api/pay/unifiedOrder, é”™è¯¯å­—æ®µ=mchOrderNo, é”™è¯¯ä¿¡æ¯=å•†æˆ·è®¢å•å·ä¸èƒ½ä¸ºç©º
```

---

## âœ… éªŒè¯æ£€æŸ¥æ¸…å•

### ä»£ç è´¨é‡æ£€æŸ¥

- [x] ä»£ç ç¼–è¯‘é€šè¿‡ï¼Œæ— è¯­æ³•é”™è¯¯
- [x] å¯¼å…¥äº†å¿…è¦çš„ä¾èµ–ç±»
- [x] å¼‚å¸¸å¤„ç†é¡ºåºæ­£ç¡®ï¼ˆæ ¡éªŒå¼‚å¸¸åœ¨ä¸šåŠ¡å¼‚å¸¸ä¹‹å‰ï¼‰
- [x] æ—¥å¿—çº§åˆ«æ­£ç¡®ï¼ˆæ ¡éªŒå¼‚å¸¸ä½¿ç”¨ WARNï¼Œå…¶ä»–ä½¿ç”¨ ERRORï¼‰
- [x] é”™è¯¯æ¶ˆæ¯æå–é€»è¾‘å®Œæ•´ï¼ˆåŒ…å«è¾¹ç•Œæƒ…å†µå¤„ç†ï¼‰

### å•å…ƒæµ‹è¯•æ£€æŸ¥

- [x] æµ‹è¯•ç±»åˆ›å»ºæˆåŠŸ
- [x] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ç¼–å†™å®Œæˆï¼ˆ10ä¸ªæµ‹è¯•æ–¹æ³•ï¼‰
- [x] æµ‹è¯•è¦†ç›–ä¸‰ç§æ ¡éªŒå¼‚å¸¸ç±»å‹
- [x] åŒ…å«å›å½’æµ‹è¯•ç”¨ä¾‹
- [x] åŒ…å«è¾¹ç•Œæƒ…å†µæµ‹è¯•
- [ ] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œé€šè¿‡ï¼ˆéœ€åœ¨æœ‰ Maven ç¯å¢ƒä¸­æ‰§è¡Œï¼‰
- [ ] è¦†ç›–ç‡è¾¾åˆ° 80% ä»¥ä¸Šï¼ˆéœ€åœ¨æœ‰ Maven ç¯å¢ƒä¸­éªŒè¯ï¼‰

### åŠŸèƒ½éªŒè¯æ£€æŸ¥

- [ ] ä¸‰ä¸ªæœåŠ¡æ¨¡å—æ­£å¸¸å¯åŠ¨
- [ ] MethodArgumentNotValidException æ­£ç¡®å¤„ç†å¹¶è¿”å›è§„èŒƒå“åº”
- [ ] BindException æ­£ç¡®å¤„ç†å¹¶è¿”å›è§„èŒƒå“åº”
- [ ] ConstraintViolationException æ­£ç¡®å¤„ç†å¹¶è¿”å›è§„èŒƒå“åº”
- [ ] å“åº”æ ¼å¼ç¬¦åˆ ApiRes è§„èŒƒï¼ˆcode=11, msgåŒ…å«é”™è¯¯ä¿¡æ¯ï¼‰
- [ ] æ—¥å¿—æ­£ç¡®è®°å½• WARN çº§åˆ«ä¿¡æ¯
- [ ] ç°æœ‰ä¸šåŠ¡å¼‚å¸¸å¤„ç†æœªå—å½±å“

---

## ğŸ“Š é¢„æœŸæµ‹è¯•ç»“æœ

### å•å…ƒæµ‹è¯•è¾“å‡ºç¤ºä¾‹

```
-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running com.jeequan.jeepay.core.exception.BizExceptionResolverTest
Tests run: 10, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.523 sec

Results :

Tests run: 10, Failures: 0, Errors: 0, Skipped: 0

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
```

### JaCoCo è¦†ç›–ç‡æŠ¥å‘Šç¤ºä¾‹

```
BizExceptionResolver
- Line Coverage: 85% (34/40 lines)
- Branch Coverage: 80% (12/15 branches)
- Method Coverage: 100% (2/2 methods)
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šæµ‹è¯•ç¼–è¯‘å¤±è´¥

**ç°è±¡**: ç¼ºå°‘ Mockito æˆ– JUnit ä¾èµ–

**è§£å†³**: ç¡®è®¤çˆ¶ pom.xml ä¸­å·²é…ç½®æµ‹è¯•ä¾èµ–ï¼š
```xml
<dependency>
    <groupId>junit</groupId>
    <artifactId>junit</artifactId>
    <version>4.13.2</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.mockito</groupId>
    <artifactId>mockito-core</artifactId>
    <version>3.9.0</version>
    <scope>test</scope>
</dependency>
```

### é—®é¢˜2ï¼šæ ¡éªŒå¼‚å¸¸æœªè¢«æ•è·

**ç°è±¡**: è¿”å›çš„ä¸æ˜¯ code=11 çš„è§„èŒƒå“åº”

**åŸå› **: 
- Controller æœªæ·»åŠ  `@Validated` æ³¨è§£
- å‚æ•°æœªæ·»åŠ  `@Valid` æ³¨è§£
- æ ¡éªŒæ³¨è§£é…ç½®é”™è¯¯

**è§£å†³**: æ£€æŸ¥ Controller é…ç½®ï¼Œå‚è€ƒè®¾è®¡æ–‡æ¡£ç¬¬ 11.2 èŠ‚

### é—®é¢˜3ï¼šæ—¥å¿—æœªè¾“å‡º WARN çº§åˆ«

**ç°è±¡**: æ—¥å¿—ä¸­çœ‹ä¸åˆ°å‚æ•°æ ¡éªŒå¤±è´¥çš„è®°å½•

**è§£å†³**: æ£€æŸ¥ logback-spring.xml é…ç½®ï¼š
```xml
<logger name="com.jeequan.jeepay.core.exception.BizExceptionResolver" level="WARN"/>
```

---

## ğŸ“ ä¸‹ä¸€æ­¥å·¥ä½œ

1. âœ… **ä»£ç å®ç°å®Œæˆ** - BizExceptionResolver ä¿®æ”¹å®Œæˆ
2. âœ… **å•å…ƒæµ‹è¯•ç¼–å†™å®Œæˆ** - 10ä¸ªæµ‹è¯•ç”¨ä¾‹è¦†ç›–æ‰€æœ‰åœºæ™¯
3. â³ **æ‰§è¡Œæµ‹è¯•** - éœ€åœ¨æœ‰ Maven/Java ç¯å¢ƒä¸­æ‰§è¡Œ
4. â³ **éªŒè¯è¦†ç›–ç‡** - ç¡®è®¤è¾¾åˆ° 80% ç›®æ ‡
5. â³ **é›†æˆæµ‹è¯•** - åœ¨ä¸‰ä¸ªæœåŠ¡æ¨¡å—ä¸­å®é™…éªŒè¯
6. â³ **æ–‡æ¡£æ›´æ–°** - æ›´æ–° API æ¥å£æ–‡æ¡£è¯´æ˜æ ¡éªŒé”™è¯¯å“åº”æ ¼å¼

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- è®¾è®¡æ–‡æ¡£: ã€Šå…¨å±€æ ¡éªŒå¼‚å¸¸å¤„ç†è®¾è®¡æ–‡æ¡£ã€‹
- ä¿®æ”¹æ–‡ä»¶: `jeepay-core/src/main/java/com/jeequan/jeepay/core/exception/BizExceptionResolver.java`
- æµ‹è¯•æ–‡ä»¶: `jeepay-core/src/test/java/com/jeequan/jeepay/core/exception/BizExceptionResolverTest.java`
- JaCoCo é…ç½®: çˆ¶ pom.xml ä¸­çš„ jacoco-maven-plugin é…ç½®

---

**æµ‹è¯•è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-15  
**çŠ¶æ€**: å¾…æ‰§è¡Œæµ‹è¯•éªŒè¯
