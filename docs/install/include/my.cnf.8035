# MySQL 8.0.35 优化配置文件
# 针对 Jeepay 支付系统的性能和安全优化
# 升级后请将此文件替换原有的 my.cnf

[client]
#password   = your_password
port        = 3306
# Docker下无需设置 目录
# socket      = /tmp/mysql.sock

[mysqld]
port        = 3306

# Docker必须要设置secure_file_priv
secure_file_priv=/var/lib/mysql
# Docker下无需设置 目录
# socket      = /tmp/mysql.sock
#  datadir = /usr/local/mysql/var

skip-external-locking
key_buffer_size = 32M
max_allowed_packet = 16M
table_open_cache = 128
sort_buffer_size = 2M
net_buffer_length = 8K
read_buffer_size = 256K
read_rnd_buffer_size = 512K
myisam_sort_buffer_size = 8M

# Don't listen on a TCP/IP port at all. This can be a security enhancement,
# if all processes that need to connect to mysqld run on the same host.
# All interaction with mysqld must be made via Unix sockets or named pipes.
# Note that using this option without enabling named pipes on Windows
# (via the "enable-named-pipe" option) will render mysqld useless!
# 
explicit_defaults_for_timestamp = true
#skip-networking

# 连接管理优化 (MySQL 8.0.35 特性)
max_connections = 1000
max_connect_errors = 10
open_files_limit = 65535

# 身份认证配置 (推荐使用新的认证插件)
default_authentication_plugin = caching_sha2_password

# 二进制日志配置
log-bin=mysql-bin
binlog_format=mixed
server-id   = 1
binlog_expire_logs_seconds = 864000
early-plugin-load = ""

# 存储引擎配置
default_storage_engine = InnoDB
innodb_file_per_table = 1

# InnoDB 性能优化 (MySQL 8.0.35 增强特性)
# Docker下无需设置 目录
# innodb_data_home_dir = /usr/local/mysql/var
# innodb_data_file_path = ibdata1:10M:autoextend
# innodb_log_group_home_dir = /usr/local/mysql/var

# 内存配置优化 - 根据可用内存调整
innodb_buffer_pool_size = 256M  # 建议设置为可用内存的70%
innodb_log_file_size = 64M      # 增大日志文件大小提升性能
innodb_log_buffer_size = 16M    # 增大日志缓冲区
innodb_flush_log_at_trx_commit = 2  # 提升性能，略降安全性
innodb_lock_wait_timeout = 50

# I/O 性能优化 (MySQL 8.0.35 特性)
innodb_io_capacity = 2000       # SSD 优化设置
innodb_io_capacity_max = 4000   # 最大 I/O 容量
innodb_read_io_threads = 8      # 读线程数
innodb_write_io_threads = 8     # 写线程数

# 查询缓存配置 (MySQL 8.0 中已移除 query_cache)
# query_cache 在 MySQL 8.0 中不再可用，依赖 InnoDB 缓冲池

# 临时表优化
tmp_table_size = 64M
max_heap_table_size = 64M

# 安全配置增强
# 密码验证插件配置
validate_password.policy = MEDIUM
validate_password.length = 8
validate_password.number_count = 1
validate_password.special_char_count = 1

# SSL 配置（生产环境推荐启用）
# ssl-cert = /etc/mysql/ssl/server-cert.pem
# ssl-key = /etc/mysql/ssl/server-key.pem
# ssl-ca = /etc/mysql/ssl/ca-cert.pem

# 慢查询日志配置
slow_query_log = 1
slow_query_log_file = /var/log/mysql/mysql-slow.log
long_query_time = 2

# 错误日志配置
log_error = /var/log/mysql/error.log

# 通用查询日志（调试时启用，生产环境建议关闭）
# general_log = 1
# general_log_file = /var/log/mysql/mysql.log

# 字符集配置
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# 时区配置
default-time-zone = '+08:00'

# 连接超时配置
wait_timeout = 300
interactive_timeout = 300

# MySQL 8.0.35 新特性配置
# 改进的成本优化器
optimizer_switch = 'index_merge=on,index_merge_union=on,index_merge_sort_union=on,index_merge_intersection=on,engine_condition_pushdown=on,index_condition_pushdown=on,mrr=on,mrr_cost_based=on,block_nested_loop=on,batched_key_access=off,materialization=on,semijoin=on,loosescan=on,firstmatch=on,duplicateweedout=on,subquery_materialization_cost_based=on,use_index_extensions=on'

# 并行查询优化（如果支持）
# innodb_parallel_read_threads = 4

# 资源组配置（MySQL 8.0 特性）
# resource_group_enabled = ON

[mysqldump]
quick
max_allowed_packet = 16M

[mysql]
no-auto-rehash
# Remove the next comment character if you are not familiar with SQL
#safe-updates
default-character-set = utf8mb4

[myisamchk]
key_buffer_size = 20M
sort_buffer_size = 20M
read_buffer = 2M
write_buffer = 2M

[mysqlhotcopy]
interactive-timeout