# Jeepay æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

## ğŸ“Œ ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–é’ˆå¯¹Jeepayèšåˆæ”¯ä»˜ç³»ç»Ÿåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½é—®é¢˜ï¼Œé€šè¿‡**ç´¢å¼•ä¼˜åŒ–**ã€**SQLæ”¹å†™**ã€**ç¼“å­˜ç­–ç•¥**å’Œ**è¿æ¥æ± è°ƒä¼˜**å››ä¸ªé˜¶æ®µçš„ä¼˜åŒ–ï¼Œå…¨é¢æå‡ç³»ç»Ÿæ€§èƒ½ã€‚

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

- âœ… è®¢å•æŸ¥è¯¢å“åº”æ—¶é—´ï¼šä» 500ms é™è‡³ 50ms ä»¥å†…ï¼ˆæå‡10å€ï¼‰
- âœ… åˆ—è¡¨åˆ†é¡µæŸ¥è¯¢ï¼šæ”¯æŒç™¾ä¸‡çº§æ•°æ®ä¸‹ 100ms å†…å“åº”
- âœ… ç»Ÿè®¡æŠ¥è¡¨æŸ¥è¯¢ï¼šå¤æ‚èšåˆæŸ¥è¯¢æ§åˆ¶åœ¨ 200ms å†…
- âœ… æ•°æ®åº“è¿æ¥æ± åˆ©ç”¨ç‡ï¼šä»å³°å€¼ 80% é™è‡³ 50% ä»¥ä¸‹
- âœ… ç¼“å­˜å‘½ä¸­ç‡ï¼šè¾¾åˆ° 80% ä»¥ä¸Š

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
jeepay/
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ sql/optimization/              # SQLä¼˜åŒ–è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ 001_add_pay_order_indexes.sql        # æ”¯ä»˜è®¢å•è¡¨ç´¢å¼•
â”‚   â”‚   â”œâ”€â”€ 002_add_refund_order_indexes.sql     # é€€æ¬¾è®¢å•è¡¨ç´¢å¼•
â”‚   â”‚   â”œâ”€â”€ 003_add_transfer_notify_indexes.sql  # è½¬è´¦å’Œé€šçŸ¥è¡¨ç´¢å¼•
â”‚   â”‚   â””â”€â”€ rollback_indexes.sql                 # ç´¢å¼•å›æ»šè„šæœ¬
â”‚   â””â”€â”€ optimization/                  # ä¼˜åŒ–æ–‡æ¡£
â”‚       â”œâ”€â”€ QUICK_START_GUIDE.md                 # å¿«é€Ÿå¼€å§‹æŒ‡å— â­
â”‚       â”œâ”€â”€ DATABASE_OPTIMIZATION_IMPLEMENTATION.md  # è¯¦ç»†å®æ–½æ–‡æ¡£
â”‚       â”œâ”€â”€ SUMMARY.md                           # ä¼˜åŒ–æ€»ç»“æŠ¥å‘Š
â”‚       â””â”€â”€ README.md                            # æœ¬æ–‡ä»¶
â”œâ”€â”€ jeepay-core/
â”‚   â””â”€â”€ src/main/java/com/jeequan/jeepay/core/model/
â”‚       â””â”€â”€ CursorPageResult.java      # æ¸¸æ ‡åˆ†é¡µç»“æœç±»ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ jeepay-components/
â”‚   â””â”€â”€ jeepay-components-cache/src/main/java/com/jeequan/jeepay/components/cache/
â”‚       â”œâ”€â”€ RedisConfig.java           # Redisé…ç½®ç±»ï¼ˆæ–°å¢ï¼‰
â”‚       â”œâ”€â”€ RedisCacheUtil.java        # Redisç¼“å­˜å·¥å…·ç±»ï¼ˆæ–°å¢ï¼‰
â”‚       â””â”€â”€ CacheKeyConstants.java     # ç¼“å­˜Keyå¸¸é‡ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ jeepay-service/
â”‚   â””â”€â”€ src/main/java/com/jeequan/jeepay/service/
â”‚       â”œâ”€â”€ mapper/
â”‚       â”‚   â”œâ”€â”€ PayOrderMapper.java    # Mapperæ¥å£ï¼ˆå·²ä¿®æ”¹ï¼‰
â”‚       â”‚   â””â”€â”€ PayOrderMapper.xml     # Mapper XMLï¼ˆå·²ä¿®æ”¹ï¼‰
â”‚       â””â”€â”€ impl/
â”‚           â””â”€â”€ PayOrderService.java   # Serviceå®ç°ï¼ˆå·²ä¿®æ”¹ï¼‰
â””â”€â”€ conf/devCommons/config/
    â””â”€â”€ application.yml                # è¿æ¥æ± é…ç½®ï¼ˆå·²ä¼˜åŒ–ï¼‰
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 5åˆ†é’Ÿå¿«é€Ÿéƒ¨ç½²

```bash
# 1. æ‰§è¡Œç´¢å¼•åˆ›å»ºï¼ˆè¿æ¥æ•°æ®åº“ï¼‰
mysql -u root -p jeepaydb < docs/sql/optimization/001_add_pay_order_indexes.sql
mysql -u root -p jeepaydb < docs/sql/optimization/002_add_refund_order_indexes.sql
mysql -u root -p jeepaydb < docs/sql/optimization/003_add_transfer_notify_indexes.sql

# 2. ç¡®ä¿Redisæ­£å¸¸è¿è¡Œ
redis-cli ping  # åº”è¿”å› PONG

# 3. é‡å¯åº”ç”¨
./shutdown.sh && ./startup.sh

# 4. éªŒè¯ä¼˜åŒ–æ•ˆæœ
# è®¿é—® Druid ç›‘æ§é¢æ¿
open http://localhost:9217/druid/
```

è¯¦ç»†éƒ¨ç½²æ­¥éª¤è¯·å‚è€ƒï¼š[å¿«é€Ÿå¼€å§‹æŒ‡å—](./QUICK_START_GUIDE.md)

## ğŸ“Š ä¼˜åŒ–å†…å®¹

### ç¬¬ä¸€é˜¶æ®µï¼šç´¢å¼•ä¼˜åŒ–

åˆ›å»ºäº†12ä¸ªé’ˆå¯¹æ€§ç´¢å¼•ï¼Œè¦†ç›–é«˜é¢‘æŸ¥è¯¢åœºæ™¯ï¼š

| è¡¨å | ç´¢å¼•æ•°é‡ | ä¸»è¦ä¼˜åŒ–åœºæ™¯ |
|-----|---------|-------------|
| t_pay_order | 6ä¸ª | è®¢å•åˆ—è¡¨ã€ç»Ÿè®¡æŸ¥è¯¢ã€è¶…æ—¶æ‰«æ |
| t_refund_order | 3ä¸ª | é€€æ¬¾åˆ—è¡¨ã€å…³è”æŸ¥è¯¢ |
| t_transfer_order | 2ä¸ª | è½¬è´¦åˆ—è¡¨ |
| t_mch_notify_record | 1ä¸ª | é€šçŸ¥é‡è¯• |

**é¢„æœŸæ”¶ç›Š**ï¼šæŸ¥è¯¢æ€§èƒ½æå‡ 60%-80%

### ç¬¬äºŒé˜¶æ®µï¼šSQLæŸ¥è¯¢ä¼˜åŒ–

#### 1. æ¸¸æ ‡åˆ†é¡µå®ç°
```java
// æ›¿ä»£ä¼ ç»Ÿçš„ OFFSET åˆ†é¡µ
CursorPageResult<PayOrder> result = payOrderService.listByCursor(
    payOrder, paramJSON, 20, cursor
);
```
**æ€§èƒ½æå‡**ï¼šæ·±åˆ†é¡µæŸ¥è¯¢æå‡ 10 å€ä»¥ä¸Š

#### 2. ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ä¼˜åŒ–å‰ï¼šDATE_FORMAT å¯¼è‡´ç´¢å¼•å¤±æ•ˆ
DATE_FORMAT(created_at, '%m-%d')

-- ä¼˜åŒ–åï¼šä½¿ç”¨ DATE å‡½æ•°
DATE(created_at)
```
**æ€§èƒ½æå‡**ï¼šç»Ÿè®¡æŸ¥è¯¢æå‡ 5 å€

#### 3. ä¸‰åˆä¸€è®¢å•æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ä¼˜åŒ–å‰ï¼šOR æ¡ä»¶æ— æ³•ä½¿ç”¨ç´¢å¼•
WHERE pay_order_id = 'X' OR mch_order_no = 'X' OR channel_order_no = 'X'

-- ä¼˜åŒ–åï¼šUNION æ¯ä¸ªéƒ½èµ°ç´¢å¼•
SELECT ... WHERE pay_order_id = 'X'
UNION
SELECT ... WHERE mch_order_no = 'X'
UNION
SELECT ... WHERE channel_order_no = 'X'
```
**æ€§èƒ½æå‡**ï¼šæŸ¥è¯¢æå‡ 2-3 å€

### ç¬¬ä¸‰é˜¶æ®µï¼šç¼“å­˜ç­–ç•¥

#### ä¸¤çº§ç¼“å­˜æ¶æ„
```
è¯·æ±‚ -> Redisç¼“å­˜ -> æ•°æ®åº“
       â†“ æœªå‘½ä¸­
    è®¾ç½®ç¼“å­˜ <- æŸ¥è¯¢DB
```

#### æ ¸å¿ƒç‰¹æ€§
- âœ… **é˜²ç©¿é€**ï¼šç©ºå€¼ç¼“å­˜ï¼ˆ5åˆ†é’Ÿï¼‰
- âœ… **é˜²é›ªå´©**ï¼šéšæœºè¿‡æœŸæ—¶é—´ï¼ˆÂ±5åˆ†é’Ÿï¼‰
- âœ… **è‡ªåŠ¨é™çº§**ï¼šRedisä¸å¯ç”¨æ—¶é™çº§åˆ°DB
- âœ… **ç¼“å­˜å¤±æ•ˆ**ï¼šè®¢å•çŠ¶æ€å˜æ›´æ—¶è‡ªåŠ¨æ¸…ç†

#### ä½¿ç”¨ç¤ºä¾‹
```java
// å¸¦ç¼“å­˜çš„è®¢å•æŸ¥è¯¢
PayOrder order = payOrderService.getByIdWithCache(payOrderId);

// å¸¦ç¼“å­˜çš„å•†æˆ·è®¢å•æŸ¥è¯¢
PayOrder order = payOrderService.getByMchOrderNoWithCache(mchNo, mchOrderNo);
```

**é¢„æœŸæ”¶ç›Š**ï¼šå‡å°‘ 70% çš„æ•°æ®åº“è¯·æ±‚

### ç¬¬å››é˜¶æ®µï¼šè¿æ¥æ± ä¼˜åŒ–

| å‚æ•° | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | è¯´æ˜ |
|------|-------|-------|------|
| max-active | 30 | 50 | æå‡å¹¶å‘èƒ½åŠ› |
| max-wait | 60s | 10s | å¿«é€Ÿå¤±è´¥ |
| slowSqlMillis | 5s | 2s | æ›´ä¸¥æ ¼ç›‘æ§ |

**é¢„æœŸæ”¶ç›Š**ï¼šå¹¶å‘èƒ½åŠ›æå‡ 40%

## ğŸ” ç›‘æ§ä¸éªŒè¯

### Druid ç›‘æ§é¢æ¿

è®¿é—®åœ°å€ï¼š`http://localhost:9217/druid/`

ç›‘æ§å†…å®¹ï¼š
- SQL æ‰§è¡Œç»Ÿè®¡
- æ…¢ SQL è®°å½•
- è¿æ¥æ± çŠ¶æ€
- Web åº”ç”¨ç»Ÿè®¡

### Redis ç›‘æ§

```bash
# æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
redis-cli INFO stats | grep keyspace_hits

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
redis-cli INFO memory | grep used_memory_human

# å®æ—¶ç›‘æ§ç¼“å­˜æ“ä½œ
redis-cli MONITOR | grep "jeepay:pay"
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•

æ¨èä½¿ç”¨ JMeter è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼š

| æµ‹è¯•åœºæ™¯ | å¹¶å‘æ•° | æ•°æ®é‡ | ç›®æ ‡å“åº”æ—¶é—´ |
|---------|-------|-------|-------------|
| è®¢å•è¯¦æƒ…æŸ¥è¯¢ | 500 | 100ä¸‡ | < 50ms |
| è®¢å•åˆ—è¡¨åˆ†é¡µ | 200 | 100ä¸‡ | < 100ms |
| ç»Ÿè®¡æŸ¥è¯¢ | 50 | 100ä¸‡ | < 200ms |

## âš ï¸ æ³¨æ„äº‹é¡¹

### éƒ¨ç½²å‰å¿…è¯»

1. **æ•°æ®å¤‡ä»½**ï¼šåŠ¡å¿…å…ˆå¤‡ä»½æ•°æ®åº“
2. **æµ‹è¯•ç¯å¢ƒéªŒè¯**ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†æµ‹è¯•
3. **ä½å³°æœŸæ‰§è¡Œ**ï¼šç´¢å¼•åˆ›å»ºå»ºè®®åœ¨å‡Œæ™¨æ‰§è¡Œ
4. **ç›‘æ§å‘Šè­¦**ï¼šéƒ¨ç½²åå¯†åˆ‡å…³æ³¨ç›‘æ§æŒ‡æ ‡

### å¸¸è§é—®é¢˜

**Q1: ç´¢å¼•åˆ›å»ºæ—¶é—´è¿‡é•¿ï¼Ÿ**
A: å¤§è¡¨åˆ›å»ºç´¢å¼•å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œå»ºè®®åˆ†æ‰¹æ‰§è¡Œï¼Œå…ˆåœ¨ä»åº“éªŒè¯ã€‚

**Q2: ç¼“å­˜æœªç”Ÿæ•ˆï¼Ÿ**
A: æ£€æŸ¥Redisè¿æ¥é…ç½®ï¼Œç¡®è®¤ `RedisCacheUtil` Beanæ­£ç¡®æ³¨å…¥ã€‚

**Q3: æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Ÿ**
A: æ£€æŸ¥æ•°æ®é‡æ˜¯å¦è¶³å¤Ÿå¤§ï¼Œå°æ•°æ®é‡æ— æ³•ä½“ç°ä¼˜åŒ–æ•ˆæœã€‚

æ›´å¤šé—®é¢˜è¯·å‚è€ƒï¼š[å¿«é€Ÿå¼€å§‹æŒ‡å— - å¸¸è§é—®é¢˜](./QUICK_START_GUIDE.md#å¸¸è§é—®é¢˜)

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœä¼˜åŒ–åå‡ºç°é—®é¢˜ï¼Œå¯å¿«é€Ÿå›æ»šï¼š

```bash
# 1. å›æ»šç´¢å¼•
mysql -u root -p jeepaydb < docs/sql/optimization/rollback_indexes.sql

# 2. å›æ»šé…ç½®ï¼ˆå¦‚æœ‰å¤‡ä»½ï¼‰
cp conf/devCommons/config/application.yml.bak conf/devCommons/config/application.yml

# 3. é‡å¯åº”ç”¨
./shutdown.sh && ./startup.sh
```

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœ

### é¢„æœŸæ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|------|-------|-------|---------|
| è®¢å•æŸ¥è¯¢ | 500ms | 50ms | **10å€** |
| åˆ—è¡¨åˆ†é¡µ | 1000ms | 100ms | **10å€** |
| æ·±åˆ†é¡µ | 5000ms | 200ms | **25å€** |
| ç»Ÿè®¡æŸ¥è¯¢ | 3000ms | 200ms | **15å€** |
| è¿æ¥æ± ä½¿ç”¨ç‡ | 80% | 50% | **é™ä½37.5%** |

### å®é™…æµ‹è¯•

éƒ¨ç½²åè¯·æŒ‰ç…§ä»¥ä¸‹æ–¹å¼æ”¶é›†å®é™…æ•°æ®ï¼š

1. ä½¿ç”¨ JMeter è¿›è¡Œå‹åŠ›æµ‹è¯•
2. è®°å½• Druid ç›‘æ§æ•°æ®
3. å¯¹æ¯”ä¼˜åŒ–å‰åçš„æ—¥å¿—
4. æ›´æ–°æœ¬æ–‡æ¡£çš„å®é™…æµ‹è¯•æ•°æ®

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å¿…è¯»**: [å¿«é€Ÿå¼€å§‹æŒ‡å—](./QUICK_START_GUIDE.md) - 5åˆ†é’Ÿå¿«é€Ÿéƒ¨ç½²
- **è¯¦ç»†**: [è¯¦ç»†å®æ–½æ–‡æ¡£](./DATABASE_OPTIMIZATION_IMPLEMENTATION.md) - å®Œæ•´å®æ–½è¯´æ˜
- **æ€»ç»“**: [ä¼˜åŒ–æ€»ç»“æŠ¥å‘Š](./SUMMARY.md) - é¡¹ç›®æˆæœæ€»ç»“

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- æ•°æ®åº“ï¼šMySQL 5.7+
- ç¼“å­˜ï¼šRedis 5.0+
- ORMæ¡†æ¶ï¼šMyBatis Plus 3.x
- è¿æ¥æ± ï¼šDruid 1.2.x
- åç«¯æ¡†æ¶ï¼šSpring Boot 2.x

## ğŸ‘¥ è´¡çŒ®æŒ‡å—

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼š

1. æŸ¥çœ‹ [å¸¸è§é—®é¢˜](./QUICK_START_GUIDE.md#å¸¸è§é—®é¢˜)
2. æäº¤ Issue åˆ°é¡¹ç›®ä»“åº“
3. æäº¤ Pull Requestï¼ˆæ¬¢è¿è´¡çŒ®ï¼‰

## ğŸ“ ç‰ˆæœ¬å†å²

- **v1.0** (2025-10-15) - åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
  - å®Œæˆç´¢å¼•ä¼˜åŒ–
  - å®ŒæˆSQLæŸ¥è¯¢ä¼˜åŒ–
  - å®Œæˆç¼“å­˜ç­–ç•¥å®æ–½
  - å®Œæˆè¿æ¥æ± ä¼˜åŒ–

## ğŸ“„ è®¸å¯è¯

æœ¬ä¼˜åŒ–æ–¹æ¡ˆéµå¾ª Jeepay é¡¹ç›®çš„è®¸å¯è¯ï¼ˆLGPL-3.0ï¼‰

---

**ç»´æŠ¤å›¢é˜Ÿ**: æ•°æ®åº“ä¼˜åŒ–å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-15  
**è”ç³»æ–¹å¼**: é€šè¿‡é¡¹ç›® Issue è”ç³»

---

â­ å¦‚æœè¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆå¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ Star æ”¯æŒï¼
