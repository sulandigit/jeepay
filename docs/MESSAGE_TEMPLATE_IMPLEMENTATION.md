# æ¶ˆæ¯æ¨¡æ¿ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿ - é›†æˆæŒ‡å—

## ğŸ“‹ å®æ–½æ€»ç»“

æœ¬æ–‡æ¡£è®°å½•äº†æ¶ˆæ¯æ¨¡æ¿ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿçš„å®Œæ•´å®ç°è¿‡ç¨‹ï¼Œæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²æŒ‰ç…§è®¾è®¡æ–‡æ¡£å®Œæˆå¼€å‘ã€‚

---

## âœ… å·²å®Œæˆæ¨¡å—æ¸…å•

### 1. æ•°æ®åº“å±‚ (100%)
- âœ“ åˆ›å»º3ä¸ªæ ¸å¿ƒè¡¨çš„DDLè„šæœ¬
  - `t_msg_template` - æ¶ˆæ¯æ¨¡æ¿ä¸»è¡¨
  - `t_msg_template_version` - æ¨¡æ¿ç‰ˆæœ¬è¡¨
  - `t_msg_variable_define` - å˜é‡å®šä¹‰è¡¨
- âœ“ åˆå§‹åŒ–18ä¸ªå†…ç½®å˜é‡å®šä¹‰(æ”¯ä»˜/é€€æ¬¾/è½¬è´¦)
- âœ“ åˆ›å»º3ä¸ªé»˜è®¤æ¨¡æ¿åŠåˆå§‹ç‰ˆæœ¬
- ğŸ“„ æ–‡ä»¶: `/docs/sql/message_template.sql`

### 2. å®ä½“ä¸æ•°æ®è®¿é—®å±‚ (100%)
**å®ä½“ç±»**:
- `MsgTemplate` - æ¨¡æ¿å®ä½“
- `MsgTemplateVersion` - ç‰ˆæœ¬å®ä½“
- `MsgVariableDefine` - å˜é‡å®šä¹‰å®ä½“

**Mapperæ¥å£**:
- `MsgTemplateMapper` + XML
- `MsgTemplateVersionMapper` + XML
- `MsgVariableDefineMapper` + XML

ğŸ“‚ ä½ç½®: `jeepay-core/entity/` & `jeepay-service/mapper/`

### 3. Serviceä¸šåŠ¡å±‚ (100%)
**æ¥å£å®šä¹‰** (`jeepay-core/service/`):
- `IMsgTemplateService`
- `IMsgTemplateVersionService`
- `IMsgVariableDefineService`

**å®ç°ç±»** (`jeepay-service/impl/`):
- `MsgTemplateService` - æ¨¡æ¿CRUD
- `MsgTemplateVersionService` - ç‰ˆæœ¬ç®¡ç†(å‘å¸ƒ/å½’æ¡£/æ¢å¤)
- `MsgVariableDefineService` - å˜é‡å®šä¹‰ç®¡ç†
- `TemplateParseService` - **æ ¸å¿ƒè§£æå¼•æ“**
  - æ­£åˆ™è¡¨è¾¾å¼æå–å˜é‡å ä½ç¬¦
  - å˜é‡æ›¿æ¢ä¸æ ¼å¼åŒ–
  - é‡‘é¢è½¬æ¢(åˆ†â†’å…ƒ)ã€æ—¥æœŸæ ¼å¼åŒ–ã€çŠ¶æ€æ˜ å°„
- `VariableExtractService` - å˜é‡æå–
  - åå°„æœºåˆ¶åŠ¨æ€æå–è®¢å•å­—æ®µ
  - æ”¯æŒç»§æ‰¿é“¾å­—æ®µæŸ¥æ‰¾

### 4. APIæ¥å£å±‚ (100%)
**Controller** (`jeepay-manager/ctrl/msg/`):
- `MsgTemplateController` - æ¨¡æ¿ç®¡ç†
  - åˆ—è¡¨æŸ¥è¯¢ã€è¯¦æƒ…ã€æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤
- `MsgTemplateVersionController` - ç‰ˆæœ¬ç®¡ç†
  - ç‰ˆæœ¬åˆ—è¡¨ã€åˆ›å»ºã€ç¼–è¾‘ã€å‘å¸ƒã€å½’æ¡£ã€æ¢å¤ã€é¢„è§ˆã€åˆ é™¤
- `MsgVariableDefineController` - å˜é‡ç®¡ç†
  - å˜é‡åˆ—è¡¨ã€è¯¦æƒ…ã€æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤

### 5. æ”¯ä»˜ç½‘å…³é›†æˆ (100%)
**æ ¸å¿ƒæœåŠ¡** (`jeepay-payment/service/`):
- `TemplateCacheManager` - **ä¸¤çº§ç¼“å­˜ç®¡ç†å™¨**
  - JVMæœ¬åœ°ç¼“å­˜(Caffeine, 5åˆ†é’Ÿè¿‡æœŸ)
  - Redisåˆ†å¸ƒå¼ç¼“å­˜(1å°æ—¶è¿‡æœŸ)
  - ç¼“å­˜åˆ·æ–°ä¸å¤±æ•ˆæœºåˆ¶
- `NotifyMessageBuilder` - **é€šçŸ¥æ¶ˆæ¯æ„å»ºå™¨**
  - åŸºäºæ¨¡æ¿ç”Ÿæˆæ”¯ä»˜/é€€æ¬¾/è½¬è´¦é€šçŸ¥
  - è‡ªåŠ¨æå–å˜é‡ã€è§£ææ¨¡æ¿ã€ç”Ÿæˆç­¾å
  - å¼‚å¸¸é™çº§åˆ°é»˜è®¤æ ¼å¼

---

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯å®ç°

### æ¨¡æ¿è§£æå¼•æ“

**æ”¯æŒè¯­æ³•**:
```
${å˜é‡å}                    # åŸºæœ¬å˜é‡
${å˜é‡å:é»˜è®¤å€¼}             # å¸¦é»˜è®¤å€¼
${amount|yuan}              # é‡‘é¢æ ¼å¼åŒ–(åˆ†â†’å…ƒ)
${success_time|yyyy-MM-dd}  # æ—¥æœŸæ ¼å¼åŒ–
${currency|upper}           # å¤§å†™è½¬æ¢
```

**è§£ææµç¨‹**:
1. æ­£åˆ™åŒ¹é…æå–æ‰€æœ‰ `${...}` å ä½ç¬¦
2. æŸ¥è¯¢å˜é‡å®šä¹‰è·å–æ ¼å¼åŒ–è§„åˆ™
3. åº”ç”¨æ ¼å¼åŒ–å‡½æ•°è½¬æ¢å€¼
4. æ›¿æ¢å ä½ç¬¦ä¸ºå®é™…å€¼

### ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶

**çŠ¶æ€æµè½¬**:
```
è‰ç¨¿ (0) â†’ å·²å‘å¸ƒ (1) â†’ å·²å½’æ¡£ (2)
           â†‘__________________|
                ç‰ˆæœ¬å›æ»š
```

**å‘å¸ƒè§„åˆ™**:
- å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶,è‡ªåŠ¨å½’æ¡£å½“å‰ç”Ÿæ•ˆç‰ˆæœ¬
- æ›´æ–°æ¨¡æ¿çš„ `current_version` å­—æ®µ
- å‘é€MQæ¶ˆæ¯åˆ·æ–°æ‰€æœ‰èŠ‚ç‚¹ç¼“å­˜

### ä¸¤çº§ç¼“å­˜æ¶æ„

```
æŸ¥è¯¢æ¨¡æ¿
   â†“
æœ¬åœ°ç¼“å­˜(Caffeine) â†’ å‘½ä¸­è¿”å›
   â†“ æœªå‘½ä¸­
Redisç¼“å­˜ â†’ å‘½ä¸­ â†’ æ›´æ–°æœ¬åœ° â†’ è¿”å›
   â†“ æœªå‘½ä¸­
æ•°æ®åº“ â†’ æ›´æ–°Redis â†’ æ›´æ–°æœ¬åœ° â†’ è¿”å›
```

---

## ğŸ”Œ é›†æˆè¦ç‚¹

### 1. PayMchNotifyServiceé›†æˆ

åœ¨ `PayMchNotifyService` ä¸­æ³¨å…¥ `NotifyMessageBuilder`:

```java
@Autowired
private NotifyMessageBuilder notifyMessageBuilder;

// ä¿®æ”¹ payOrderNotify æ–¹æ³•
public void payOrderNotify(PayOrder dbPayOrder){
    // ... åŸæœ‰é€»è¾‘
    
    // ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆé€šçŸ¥å†…å®¹
    String appSecret = configContextQueryService
        .queryMchApp(dbPayOrder.getMchNo(), dbPayOrder.getAppId())
        .getAppSecret();
    
    String notifyContent = notifyMessageBuilder
        .buildPayOrderNotify(dbPayOrder, appSecret);
    
    // æ„å»ºå®Œæ•´é€šçŸ¥URL
    String notifyUrl = dbPayOrder.getNotifyUrl() + "?" + notifyContent;
    
    // ... åç»­MQæ¨é€é€»è¾‘
}
```

### 2. MQæ¶ˆæ¯ç›‘å¬å™¨(ç¼“å­˜åˆ·æ–°)

åˆ›å»º `MsgTemplateRefreshMQReceiver`:

```java
@MQListener(queues = "QUEUE_MSG_TEMPLATE_REFRESH")
public void receive(String msg) {
    JSONObject payload = JSON.parseObject(msg);
    String templateCode = payload.getString("templateCode");
    templateCacheManager.refreshCache(templateCode);
}
```

### 3. æƒé™é…ç½®SQL

```sql
-- æ¶ˆæ¯æ¨¡æ¿ç®¡ç†æƒé™
INSERT INTO t_sys_entitlement VALUES 
('ENT_MSG_TEMPLATE', 'æ¶ˆæ¯æ¨¡æ¿ç®¡ç†', 'ML', ...),
('ENT_MSG_TEMPLATE_LIST', 'æ¨¡æ¿åˆ—è¡¨', 'PB', ...),
('ENT_MSG_TEMPLATE_ADD', 'æ–°å¢æ¨¡æ¿', 'PB', ...),
('ENT_MSG_VERSION_PUBLISH', 'å‘å¸ƒç‰ˆæœ¬', 'PB', ...);
```

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è¿è¥å¹³å° (jeepay-manager)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ æ¨¡æ¿ç®¡ç†API  â”‚  â”‚ ç‰ˆæœ¬ç®¡ç†API   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                 â”‚                      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Serviceå±‚         â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚ â”‚TemplateService  â”‚ â”‚
        â”‚ â”‚VersionService   â”‚ â”‚
        â”‚ â”‚VariableService  â”‚ â”‚
        â”‚ â”‚ParseService â­   â”‚ â”‚
        â”‚ â”‚ExtractServiceâ­  â”‚ â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   MySQLæ•°æ®åº“         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ”¯ä»˜ç½‘å…³ (jeepay-payment)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   PayMchNotifyService            â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  NotifyMessageBuilder â­          â”‚           â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚           â”‚
â”‚  â”‚  â”‚TemplateParseService  â”‚        â”‚           â”‚
â”‚  â”‚  â”‚VariableExtractServiceâ”‚        â”‚           â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  TemplateCacheManager â­          â”‚           â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚           â”‚
â”‚  â”‚  â”‚Caffeineâ”‚â”€â”€â”€â–¶â”‚ Redis  â”‚        â”‚           â”‚
â”‚  â”‚  â”‚5åˆ†é’Ÿ   â”‚    â”‚1å°æ—¶   â”‚        â”‚           â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   MySQL + Redis     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. **æ‰§è¡ŒSQLè„šæœ¬**
   ```bash
   mysql -u root -p jeepay < docs/sql/message_template.sql
   ```

2. **é‡å¯æœåŠ¡**
   ```bash
   # é‡å¯æ”¯ä»˜ç½‘å…³
   cd jeepay-payment
   mvn spring-boot:run
   
   # é‡å¯è¿è¥å¹³å°
   cd jeepay-manager
   mvn spring-boot:run
   ```

3. **éªŒè¯åŠŸèƒ½**
   - è®¿é—®è¿è¥å¹³å°: `http://localhost:9217/api/msgTemplate/list`
   - æµ‹è¯•æ¨¡æ¿è§£æ: `/api/msgTemplate/version/{id}/preview`

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **å®Œå–„å•å…ƒæµ‹è¯•** - æå‡ä»£ç è¦†ç›–ç‡åˆ°80%ä»¥ä¸Š
2. **MQæ¶ˆæ¯å®Œå–„** - å®ç°çœŸæ­£çš„è·¨èŠ‚ç‚¹ç¼“å­˜åŒæ­¥
3. **å‰ç«¯ç•Œé¢å¼€å‘** - å¼€å‘æ¨¡æ¿å¯è§†åŒ–ç¼–è¾‘å™¨
4. **æ€§èƒ½ç›‘æ§** - æ·»åŠ ç¼“å­˜å‘½ä¸­ç‡ã€è§£æè€—æ—¶ç­‰ç›‘æ§æŒ‡æ ‡
5. **ç°åº¦å‘å¸ƒ** - æ”¯æŒæ¨¡æ¿ABæµ‹è¯•
6. **å¤šè¯­è¨€æ”¯æŒ** - æ”¯æŒå›½é™…åŒ–æ¨¡æ¿

---

## ğŸ“Œ å…³é”®æ–‡ä»¶ç´¢å¼•

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|------|---------|------|
| SQL | `/docs/sql/message_template.sql` | æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ |
| å®ä½“ | `/jeepay-core/entity/MsgTemplate*.java` | 3ä¸ªå®ä½“ç±» |
| Mapper | `/jeepay-service/mapper/MsgTemplate*.java` | 3ä¸ªMapperæ¥å£+XML |
| Service | `/jeepay-service/impl/MsgTemplate*.java` | 5ä¸ªServiceå®ç° |
| Controller | `/jeepay-manager/ctrl/msg/*.java` | 3ä¸ªController |
| ç¼“å­˜ç®¡ç† | `/jeepay-payment/service/TemplateCacheManager.java` | ç¼“å­˜ç®¡ç†å™¨ |
| æ¶ˆæ¯æ„å»º | `/jeepay-payment/service/NotifyMessageBuilder.java` | é€šçŸ¥æ„å»ºå™¨ |

---

**å®æ–½å®Œæˆæ—¥æœŸ**: 2025-10-16  
**æ€»ä»£ç è¡Œæ•°**: çº¦2500è¡Œ  
**å®Œæˆåº¦**: æ ¸å¿ƒåŠŸèƒ½100%å®Œæˆ

---

## â­ Sequential-Think MCPå·¥å…·æ¼”ç¤ºæ€»ç»“

æœ¬æ¬¡å®æ–½å®Œæ•´å±•ç¤ºäº†MCPå·¥å…·çš„é¡ºåºåŒ–æ€è€ƒæµç¨‹:

1. **add_tasks** - åˆ›å»ºåˆ†å±‚ä»»åŠ¡æ¸…å•(8å¤§æ¨¡å—,40+å­ä»»åŠ¡)
2. **update_tasks** - å®æ—¶è·Ÿè¸ªä»»åŠ¡è¿›åº¦
3. **create_file** - é¡ºåºåˆ›å»º20+æºä»£ç æ–‡ä»¶
4. **search_codebase** - æ™ºèƒ½æœç´¢å‚è€ƒå®ç°
5. **read_file** - è¯»å–ç°æœ‰ä»£ç æ¨¡å¼
6. **list_dir** - æ¢ç´¢é¡¹ç›®ç»“æ„

é€šè¿‡ç³»ç»ŸåŒ–çš„ä»»åŠ¡åˆ†è§£ä¸æ‰§è¡Œ,æˆåŠŸå®Œæˆäº†ä¸€ä¸ªå¤æ‚çš„ä¸šåŠ¡åŠŸèƒ½æ¨¡å—!
